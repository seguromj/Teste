
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Nuance - Sistema Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f1f5f9; --whatsapp: #25d366; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        
        .main-wrapper { display: flex; flex-direction: column; height: 100vh; }
        
        .top-bar { 
            background: #0f172a; 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        
        .pdv-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        .panel-left { flex: 1.2; background: white; border-radius: 12px; padding: 20px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .panel-right { flex: 0.8; background: #e2e8f0; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; border: 2px inset #cbd5e1; }

        @media (max-width: 900px) {
            .pdv-container { flex-direction: column; overflow: visible; height: auto; padding: 10px; }
            .panel-left, .panel-right { flex: none; width: 100%; overflow: visible; box-sizing: border-box; }
            .main-wrapper { height: auto; }
            .panel-right { margin-top: 20px; background: white; border: none; padding: 0; }
        }

        h2 { margin: 0; font-size: 20px; }
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 15px 0 10px; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #475569; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: inherit; }
        
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: 600; cursor: pointer; font-size: 13px; width: 100%; display: block; margin-bottom: 8px; text-transform: uppercase; transition: opacity 0.2s; }
        .btn-importar { background: #f59e0b; color: white; }
        .btn-maps { background: #16a34a; color: white; }
        .btn-wpp-entrega { background: var(--whatsapp); color: white; }
        .btn-limpar { background: #64748b; color: white; }
        .btn-gerar { background: var(--primary); color: white; margin-top: 15px; font-size: 15px; padding: 16px; }
        .btn-print { background: var(--success); color: white; width: 100%; }
        .btn-pdf { background: #334155; color: white; width: 100%; }
        .btn-nav { background: #334155; color: white; padding: 8px 12px; width: auto; font-size: 11px; margin-left: 4px; }
        .btn-crm { background: var(--whatsapp); color: white; margin-top: 5px; }
        .btn-delete { background: var(--danger); color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-reabrir { background: var(--primary); color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-lancar { background: #10b981; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-etiqueta { background: #f59e0b; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }

        #lista-notas { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .nota-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .nota-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .nota-cliente-info b { font-size: 15px; color: #16a34a; display: block; text-transform: uppercase; }
        .nota-cliente-info span { font-size: 11px; color: #64748b; }
        
        .nota-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .nota-status-row { display: flex; align-items: center; gap: 8px; padding-top: 10px; border-top: 1px solid #f1f5f9; margin-top: 5px; }
        .btn-icon-wpp { background: #25d366; color: white; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }

        .status-badge { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; color: white; text-transform: uppercase; border: none; outline: none; }
        .st-pendente { background: #64748b; }
        .st-preparando { background: #3b82f6; }
        .st-rua { background: #f59e0b; }
        .st-entregue { background: #10b981; }

        .product-folder { background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .folder-header { background: #f8fafc; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #eee; }
        .folder-content { padding: 12px; background: #fff; border-top: 1px solid #eee; }
        .sub-folder { border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 5px; }
        .sub-folder-header { background: #f1f5f9; padding: 8px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; }
        .sub-folder-content { padding: 10px; background: #fff; }

        #area-cupom, #area-etiqueta { 
            width: 80mm; padding: 5mm; background: white; color: #000;
            font-family: 'Courier New', Courier, monospace; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid #ddd; margin-bottom: 20px;
        }
        #area-etiqueta { min-height: 50mm; display: none; border: 2px solid #000; }
        .empresa-nome { text-align: center; font-family: 'Trebuchet MS', sans-serif; font-size: 26px; font-weight: 900; letter-spacing: 2px; margin-bottom: 2px; }
        .divisor { border-top: 1px dashed #000; margin: 5px 0; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 95%; max-width: 600px; border-radius: 12px; position: relative; }
        .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }

        @media print {
            body * { visibility: hidden; }
            #area-cupom, #area-cupom *, #area-etiqueta, #area-etiqueta * { visibility: visible; }
            #area-cupom, #area-etiqueta { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
        }
    </style>
</head>
<body onload="atualizarCupom()">

<div class="main-wrapper">
    <div class="top-bar">
        <h2>PDV NUANCE</h2>
        <div style="display:flex;">
            <button class="btn btn-nav" onclick="abrirGestao()">üìÅ NOTAS</button>
            <button class="btn btn-nav" onclick="abrirRankingClientes()">üë§ CLIENTES</button>
            <button class="btn btn-nav" style="background:#0ea5e9;" onclick="abrirRankingProdutos()">üì¶ PRODUTOS</button>
        </div>
    </div>

    <div class="pdv-container">
        <div class="panel-left">
            <div class="import-box" style="background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label>üì¶ IMPORTAR PEDIDO:</label>
                <textarea id="input-importacao" style="width: 100%; height: 100px; font-size: 13px; margin-bottom: 10px;" placeholder="Cole a mensagem aqui..."></textarea>
                <div class="grid">
                    <button class="btn btn-importar" onclick="processarTexto()">Processar Mensagem</button>
                    <button class="btn btn-maps" onclick="abrirGoogleMaps()">üìç Mapa Cliente</button>
                </div>
                <div class="grid">
                    <button class="btn btn-wpp-entrega" onclick="enviarWppEntregador()">üì≤ Enviar Motoboy</button>
                    <button class="btn btn-limpar" onclick="limparCampos()">üßπ Limpar Tudo</button>
                </div>
            </div>

            <div class="section-title">Dados da Nota</div>
            <div class="grid">
                <div class="form-group"><label>Nome</label><input type="text" id="nome" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Data/Hora</label><input type="text" id="data-hora" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsapp"></div>
                <div class="form-group"><label>CPF / Ref</label><input type="text" id="CPF"></div>
            </div>

            <div class="section-title">Endere√ßo de Entrega</div>
            <div class="grid">
                <div class="form-group"><label>Rua/Avenida</label><input type="text" id="rua" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>N¬∫/QD/LOTE</label><input type="text" id="numero" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Bairro</label><input type="text" id="bairro" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>CEP</label><input type="text" id="cep"></div>
            </div>
            <div class="form-group"><label>Complemento</label><input type="text" id="complemento"></div>

            <div class="section-title">Pagamento e Produtos</div>
            <div class="grid">
                <div class="form-group"><label>Forma de Pagamento</label><input type="text" id="pagamento"></div>
                <div class="form-group"><label>Coleta</label><input type="text" id="coleta" oninput="atualizarCupom()"></div>
            </div>
            <div class="form-group"><label>Produtos (Ex: 2x Gin)</label><textarea id="produtos-texto" style="height: 80px;" oninput="atualizarCupom()"></textarea></div>
            <div class="grid">
                <div class="form-group"><label>Total (R$)</label><input type="text" id="valor-total" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Cupom de Desconto</label><input type="text" id="cupom-input" oninput="atualizarCupom()"></div>
            </div>
            <div class="form-group"><label>Observa√ß√µes</label><input type="text" id="obs" oninput="atualizarCupom()"></div>

            <div class="section-title">üí¨ Mensagens R√°pidas</div>
            <div class="form-group">
                <select id="select-mensagem">
                    <option value="1">‚ö†Ô∏è Carrinho Abandonado</option>
                    <option value="2">üë®‚Äçüç≥ Pedido em Preparo</option>
                    <option value="3">üöÄ Saiu para Entrega</option>
                    <option value="4">‚úÖ Entregue / Feedback</option>
                </select>
                <button class="btn btn-crm" onclick="enviarMensagemRapida()">Enviar para Cliente</button>
            </div>

            <button class="btn btn-gerar" onclick="finalizarEGerar()">FINALIZAR E SALVAR</button>
        </div>

        <div class="panel-right">
            <div id="area-cupom">
                <div class="empresa-nome">NUANCE</div>
                <div style="text-align: center; font-size: 12px; border-bottom: 1px dashed #000; margin-bottom: 5px;"><strong>COMPROVANTE DE PEDIDO</strong></div>
                <div style="font-size: 12px; margin: 10px 0;">
                    DATA: <span id="view-data"></span><br>
                    CLIENTE: <span id="view-nome"></span><br>
                    ENDERE√áO: <span id="view-endereco"></span><br>
                    COLETA: <span id="view-coleta"></span>
                </div>
                <div class="divisor"></div>
                <div id="view-produtos" style="font-size: 12px; white-space: pre-wrap;"></div>
                <div class="divisor"></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;"><span>TOTAL:</span><span id="view-total">R$ 0.00</span></div>
                <div id="view-cupom-aplicado" style="font-size: 11px; margin-top: 8px; text-align: center; border: 1px dashed #000; padding: 4px; display:none;"></div>
                <div id="view-obs" style="font-size: 11px; margin-top: 10px; white-space: pre-wrap;"></div>
                <div id="view-versiculo" class="versiculo-box" style="margin-top: 15px; font-size: 11px; text-align: center; font-style: italic; border-top: 1px dashed #000; padding-top: 10px;"></div>
            </div>

            <div id="area-etiqueta">
                <div style="text-align: center; border: 2px solid #000; padding: 5px;">
                    <div style="font-weight: bold; font-size: 18px;">NUANCE DRINKS</div>
                    <div class="divisor"></div>
                    <div style="text-align: left; font-size: 14px;">
                        <strong>CLIENTE:</strong> <span id="etiq-nome"></span><br>
                        <strong>END:</strong> <span id="etiq-end"></span><br>
                        <strong>OBS:</strong> <span id="etiq-obs"></span>
                    </div>
                    <div class="divisor"></div>
                    <div id="etiq-prod" style="font-size: 14px; text-align: left; font-weight: bold;"></div>
                </div>
            </div>

            <div style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Cupom</button>
                <button class="btn btn-etiqueta" style="width:100%;" onclick="imprimirEtiqueta()">üè∑Ô∏è Etiqueta</button>
                <button class="btn btn-pdf" onclick="baixarPDF()">üíæ PDF</button>
                <button class="btn btn-limpar" style="width:100%;" onclick="limparCampos()">üßπ Limpar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalGestao" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalGestao')">√ó</span>
        <h3>Hist√≥rico e Status</h3>
        <input type="text" id="busca-nota" placeholder="Busca: Nome * Zap * CPF" onkeyup="filtrarNotas()" style="margin-bottom:15px;">
        <div id="lista-notas"></div>
    </div>
</div>

<div id="modalLancar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalLancar')">√ó</span>
        <h3>üöÄ Realizar Lan√ßamento</h3>
        <p id="lancar-info-cliente" style="font-weight: bold; color: var(--primary);"></p>
        <div id="lista-produtos-lancar"></div>
        <button class="btn btn-gerar" onclick="confirmarLancamento()">REALIZAR LAN√áAMENTO</button>
    </div>
</div>

<div id="modalRankingClientes" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalRankingClientes')">√ó</span>
        <h3>Ranking Clientes & Recompra</h3>
        <div id="lista-ranking-clientes"></div>
    </div>
</div>

<div id="modalRankingProdutos" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalRankingProdutos')">√ó</span>
        <h3>üì¶ Controle de Produtos</h3>
        <div style="background:#0f172a; color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
            Lucro Total: <span id="fin-total-lucro" style="color:#4ade80; font-weight:bold;">R$ 0,00</span>
        </div>
        <div id="lista-ranking-produtos"></div>
    </div>
</div>

<script>
    const versiculos = [
        "O Senhor √© o meu pastor, nada me faltar√°. (Salmos 23:1)", 
        "Tudo posso naquele que me fortalece. (Filipenses 4:13)", 
        "O Senhor te aben√ßoe e te guarde. (N√∫meros 6:24)", 
        "Confia no Senhor de todo o teu cora√ß√£o. (Prov√©rbios 3:5)", 
        "O amor nunca falha. (1 Cor√≠ntios 13:8)"
    ];

    function getSaudacao() {
        const h = new Date().getHours();
        return h >= 5 && h < 12 ? "Bom dia" : h >= 12 && h < 18 ? "Boa tarde" : "Boa noite";
    }

    function atualizarCupom() {
        const nome = document.getElementById('nome').value.toUpperCase();
        const end = `${document.getElementById('rua').value}, ${document.getElementById('numero').value} - ${document.getElementById('bairro').value}`;
        const prod = document.getElementById('produtos-texto').value;
        const obs = document.getElementById('obs').value;

        document.getElementById('view-nome').innerText = nome || "...";
        document.getElementById('view-data').innerText = document.getElementById('data-hora').value || "...";
        document.getElementById('view-endereco').innerText = end.includes(",  -") ? "..." : end;
        document.getElementById('view-coleta').innerText = (document.getElementById('coleta').value || "...").toUpperCase();
        document.getElementById('view-produtos').innerText = prod || "Nenhum produto";
        document.getElementById('view-total').innerText = "R$ " + (document.getElementById('valor-total').value || "0.00");
        document.getElementById('view-obs').innerText = obs;
        
        document.getElementById('etiq-nome').innerText = nome;
        document.getElementById('etiq-end').innerText = end;
        document.getElementById('etiq-obs').innerText = obs;
        document.getElementById('etiq-prod').innerText = prod;

        const cupom = document.getElementById('cupom-input').value;
        const vC = document.getElementById('view-cupom-aplicado');
        if(cupom) { vC.style.display = "block"; vC.innerText = "Pr√≥xima compra use o cupom: " + cupom.toUpperCase(); }
        else vC.style.display = "none";
        
        if(!document.getElementById('view-versiculo').innerText) {
            document.getElementById('view-versiculo').innerText = versiculos[Math.floor(Math.random() * versiculos.length)];
        }
    }

    function imprimirEtiqueta() {
        document.getElementById('area-cupom').style.display = 'none';
        document.getElementById('area-etiqueta').style.display = 'block';
        window.print();
        setTimeout(() => {
            document.getElementById('area-cupom').style.display = 'block';
            document.getElementById('area-etiqueta').style.display = 'none';
        }, 1000);
    }

    function processarTexto() {
        let texto = document.getElementById('input-importacao').value;
        if(!texto) return;
        const map = { 
            '0. DATA/HORA:': 'data-hora', '1. PEDIDO:': 'produtos-texto', '2. NOME:': 'nome', 
            '3. WHATSAPP:': 'whatsapp', '4. CEP:': 'cep', '5. N¬∫/QD/LOTE:': 'numero',
            '6. BAIRRO:': 'bairro', '7. RUA/AVENIDA:': 'rua', '8. COMPLEMENTO:': 'complemento',
            '9. TIPO DE COLETA:': 'coleta', '10. VALOR PRODUTOS:': 'valor-total'
        };
        Object.keys(map).forEach(key => {
            const regex = new RegExp(key.replace(/\//g, '\\/') + "\\s*(.*)");
            const match = texto.match(regex);
            if(match) {
                let val = match[1].trim();
                if(key === '1. PEDIDO:') val = val.replace(/(\d+x)/g, '\n$1').trim();
                if(key === '10. VALOR PRODUTOS:') val = val.replace(/R\$\s*/gi, '').trim();
                document.getElementById(map[key]).value = val;
            }
        });
        atualizarCupom();
        alert("Mensagem processada!");
    }

    function finalizarEGerar() {
        const nome = document.getElementById('nome').value;
        if(!nome) return alert("Preencha o nome.");
        const dados = { 
            id: Date.now(), 
            nome: nome, 
            data: document.getElementById('data-hora').value, 
            whatsapp: document.getElementById('whatsapp').value,
            cpf: document.getElementById('CPF').value || "",
            rua: document.getElementById('rua').value,
            numero: document.getElementById('numero').value, 
            bairro: document.getElementById('bairro').value,
            coleta: document.getElementById('coleta').value || "N√ÉO INFORMADO",
            produtos: document.getElementById('produtos-texto').value, 
            total: document.getElementById('valor-total').value,
            status: 'pendente', 
            data_criacao: new Date().toISOString()
        };
        let notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        notas.push(dados);
        localStorage.setItem('notas_nuance', JSON.stringify(notas));
        alert("Pedido salvo!");
    }

    function filtrarNotas() {
        const busca = document.getElementById('busca-nota').value.toLowerCase();
        const partes = busca.split('*').map(p => p.trim());
        const notasRaw = localStorage.getItem('notas_nuance') || '[]';
        const notas = JSON.parse(notasRaw);
        const lista = document.getElementById('lista-notas');
        
        const filtradas = notas.slice().reverse().filter(n => {
            const matchNome = (n.nome || "").toLowerCase().includes(partes[0] || "");
            const matchWhats = partes[1] ? (n.whatsapp || "").includes(partes[1]) : true;
            const matchCPF = partes[2] ? (n.cpf || "").includes(partes[2]) : true;
            return matchNome && matchWhats && matchCPF;
        });

        let html = "";
        filtradas.forEach(n => {
            html += `
            <div class="nota-card">
                <div class="nota-header">
                    <div class="nota-cliente-info">
                        <b>${n.nome}</b>
                        <span>üìç ${n.coleta.toUpperCase()} | üìÖ ${n.data || 'Sem data'} | üí∞ R$ ${n.total}</span>
                    </div>
                    <div class="nota-actions">
                        <button class="btn btn-lancar" onclick="abrirModalLancar(${n.id})">üöÄ LAN√áAR</button>
                        <button class="btn btn-reabrir" onclick="reabrirNota(${n.id})">üëÅÔ∏è</button>
                        <button class="btn btn-delete" onclick="excluirNota(${n.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="nota-status-row">
                    <div style="flex: 1;">
                        <select onchange="mudarStatus(${n.id}, this.value)" class="status-badge st-${n.status}" style="width: auto; cursor:pointer;">
                            <option value="pendente" ${n.status==='pendente'?'selected':''}>Pendente</option>
                            <option value="preparando" ${n.status==='preparando'?'selected':''}>Preparando</option>
                            <option value="rua" ${n.status==='rua'?'selected':''}>Na Rua</option>
                            <option value="entregue" ${n.status==='entregue'?'selected':''}>Entregue</option>
                        </select>
                    </div>
                    <button onclick="enviarAcompanhamento(${n.id})" class="btn-icon-wpp">
                        <span>üì≤</span> AVISAR CLIENTE
                    </button>
                </div>
            </div>`;
        });
        lista.innerHTML = html;
    }

    function abrirGestao() { 
        document.getElementById('modalGestao').style.display = 'block';
        filtrarNotas(); 
    }

    function enviarAcompanhamento(id) {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const n = notas.find(x => x.id === id);
        if(!n || !n.whatsapp) return alert("WhatsApp n√£o encontrado.");
        
        const primeiroNome = n.nome.split(' ')[0];
        const saudacao = getSaudacao();
        let msg = "";
        
        if(n.status === 'pendente') {
            msg = `Ol√°, ${primeiroNome}, ${saudacao.toLowerCase()}!\n Percebemos que seu pedido de: \n${n.produtos}\nFicou no seu carrinho!\n\n ü§ó Que tal finalizar essa compra com esse Cupom: FRETEGRATIS\n\n Link Oficial NUANCE üëá\n https://seguromj.github.io/Nuance-/`;
        } else if(n.status === 'preparando') {
            msg = `Ol√°, ${primeiroNome}!\n Sou uns dos Barman da Nuance! üë®‚Äçüç≥\nSeu pedido chegou em nossa cozinha e j√° estamos dando os √∫ltimos detalhes, para seu pedido chegar em boas condi√ß√µes e com qualidade! üòç`;
        } else if(n.status === 'rua') {
            msg = `Not√≠cia boa, ${primeiroNome}! Seu pedido acabou de sair para entrega. üöÄ\nO motoboy est√° indo para ${n.rua || n.bairro}.\n.ü•Ç`;
        } else if(n.status === 'entregue') {
            msg = `Ol√°, ${primeiroNome}! Notamos que seu pedido foi entregue. üòç\n\nEspero que goste! Se puder nos marcar no Instagram isso nos ajuda muito!\nüòâ\n\n Sa√∫de! ü•Ç‚ú®`;
        }

        if(msg) {
            window.open(`https://api.whatsapp.com/send?phone=55${n.whatsapp.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
        }
    }

    function mudarStatus(id, novoStatus) {
        let notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const nota = notas.find(n => n.id === id);
        if(nota) {
            nota.status = novoStatus;
            localStorage.setItem('notas_nuance', JSON.stringify(notas));
            filtrarNotas();
        }
    }

    function abrirRankingClientes() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const clientes = {};
        const hoje = new Date();
        notas.forEach(n => {
            if(!clientes[n.nome]) { clientes[n.nome] = { qtd: 0, ultima: n.data_criacao, tel: n.whatsapp }; }
            clientes[n.nome].qtd++;
            if(new Date(n.data_criacao) > new Date(clientes[n.nome].ultima)) { clientes[n.nome].ultima = n.data_criacao; }
        });
        const lista = document.getElementById('lista-ranking-clientes');
        lista.innerHTML = Object.entries(clientes).sort((a,b)=>b[1].qtd - a[1].qtd).map(([nome, dados]) => {
            const diasSemComprar = Math.floor((hoje - new Date(dados.ultima)) / (1000 * 60 * 60 * 24));
            const precisaAviso = diasSemComprar >= 10;
            return `
                <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div><strong>${nome}</strong> (${dados.qtd} pedidos)<br><small>√öltimo: ${diasSemComprar} dias atr√°s</small></div>
                    ${precisaAviso ? `<button class="btn btn-crm" onclick="enviarCupomSaudade('${nome}', '${dados.tel}')" style="width:auto; background:var(--warning); padding: 5px 10px;">‚ö†Ô∏è SAUDADE</button>` : '‚úÖ'}
                </div>`;
        }).join("");
        document.getElementById('modalRankingClientes').style.display = 'block';
    }

    function enviarCupomSaudade(nome, tel) {
        if(!tel) return alert("WhatsApp n√£o cadastrado.");
        const msg = `Ol√° ${nome.split(' ')[0]}! Notamos que voc√™ est√° sumido da Nuance Drinks. ü•∫\nPara matar a saudade, use o cupom *SAUDADE10* e ganhe 10% OFF no pr√≥ximo drink! ü•Ç`;
        window.open(`https://api.whatsapp.com/send?phone=55${tel.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    function abrirModalLancar(id) {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const n = notas.find(item => item.id === id);
        if(!n) return;
        document.getElementById('lancar-info-cliente').innerText = `Lan√ßar para: ${n.nome}`;
        const lista = document.getElementById('lista-produtos-lancar');
        const valoresSalvos = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        let html = "";
        if(n.produtos) {
            let itemIndex = 0;
            n.produtos.split('\n').forEach(linha => {
                const m = linha.match(/(\d+)x\s*(.*)/i);
                if(m) {
                    const qtd = parseInt(m[1]);
                    const nomeProd = m[2].trim().toUpperCase();
                    for(let i=0; i < qtd; i++) {
                        const chave = `${nomeProd}_${n.id}_${itemIndex}`;
                        html += `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; background:#f8fafc; padding:8px;">
                                <span style="font-size:12px;">${nomeProd}</span>
                                <input type="number" step="0.01" class="input-valor-lancar" data-chave="${chave}" value="${valoresSalvos[chave]||0}" style="width:80px;">
                            </div>`;
                        itemIndex++;
                    }
                }
            });
        }
        lista.innerHTML = html;
        document.getElementById('modalLancar').style.display = 'block';
    }

    function confirmarLancamento() {
        let valores = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        document.querySelectorAll('.input-valor-lancar').forEach(input => {
            valores[input.getAttribute('data-chave')] = parseFloat(input.value) || 0;
        });
        localStorage.setItem('nuance_valores_individuais', JSON.stringify(valores));
        fecharModal('modalLancar');
        alert("Lan√ßado!");
    }

    function abrirRankingProdutos() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const valoresSalvos = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        const pastas = {};
        notas.forEach(nota => {
            if(nota.produtos) {
                let itemIndex = 0;
                nota.produtos.split('\n').forEach(linha => {
                    const m = linha.match(/(\d+)x\s*(.*)/i);
                    if(m) {
                        const qtd = parseInt(m[1]);
                        const nomeProd = m[2].trim().toUpperCase();
                        if(!pastas[nomeProd]) pastas[nomeProd] = [];
                        for(let i=0; i < qtd; i++) {
                            const chave = `${nomeProd}_${nota.id}_${itemIndex}`;
                            pastas[nomeProd].push({ chave, cliente: nota.nome, data: nota.data, valor: valoresSalvos[chave] || 0 });
                            itemIndex++;
                        }
                    }
                });
            }
        });
        let lucroGeral = 0;
        document.getElementById('lista-ranking-produtos').innerHTML = Object.entries(pastas).map(([nomeProd, lista]) => {
            const subs = lista.map(item => {
                lucroGeral += parseFloat(item.valor);
                return `<div class="sub-folder"><div class="sub-folder-header" onclick="togglePasta(this)"><span>üìÇ Venda - ${item.cliente}</span><span>R$ ${parseFloat(item.valor).toFixed(2)}</span></div><div class="sub-folder-content" style="display:none;"><input type="number" step="0.01" value="${item.valor}" onchange="salvarValorIndividual('${item.chave}', this.value)" style="width:100%;"></div></div>`;
            }).join("");
            return `<div class="product-folder"><div class="folder-header" onclick="togglePasta(this)"><span>üìÅ ${nomeProd}</span><span>${lista.length} un</span></div><div class="folder-content" style="display:none;">${subs}</div></div>`;
        }).join("");
        document.getElementById('fin-total-lucro').innerText = "R$ " + lucroGeral.toFixed(2);
        document.getElementById('modalRankingProdutos').style.display = 'block';
    }

    function salvarValorIndividual(chave, valor) {
        let v = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        v[chave] = parseFloat(valor) || 0;
        localStorage.setItem('nuance_valores_individuais', JSON.stringify(v));
        abrirRankingProdutos();
    }

    function togglePasta(e) { const c = e.nextElementSibling; c.style.display = c.style.display==='none'?'block':'none'; event.stopPropagation(); }
    function fecharModal(id) { document.getElementById(id).style.display="none"; }
    
    function reabrirNota(id) {
        const n = JSON.parse(localStorage.getItem('notas_nuance')).find(x => x.id === id);
        if(n) {
            document.getElementById('nome').value = n.nome;
            document.getElementById('whatsapp').value = n.whatsapp || "";
            document.getElementById('CPF').value = n.cpf || "";
            document.getElementById('produtos-texto').value = n.produtos;
            document.getElementById('valor-total').value = n.total;
            document.getElementById('rua').value = n.rua || "";
            document.getElementById('bairro').value = n.bairro || "";
            document.getElementById('numero').value = n.numero || "";
            document.getElementById('coleta').value = n.coleta || "";
            atualizarCupom();
            fecharModal('modalGestao');
        }
    }
    function excluirNota(id) { if(confirm("Excluir?")) { let n = JSON.parse(localStorage.getItem('notas_nuance')).filter(x=>x.id!==id); localStorage.setItem('notas_nuance', JSON.stringify(n)); filtrarNotas(); } }
    function limparCampos() { document.querySelectorAll('input, textarea').forEach(i => i.value = ""); atualizarCupom(); }
    function baixarPDF() { html2pdf().from(document.getElementById('area-cupom')).save(); }
    function abrirGoogleMaps() { const end = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}`; window.open("https://www.google.com/maps/search/" + encodeURIComponent(end)); }
    function enviarWppEntregador() { const msg = `üöÄ ENTREGA\nüë§ ${document.getElementById('nome').value}\nüìç ${document.getElementById('rua').value}`; window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`); }
    function enviarMensagemRapida() {
        const nomeCompleto = document.getElementById('nome').value || "Cliente";
        const telefone = document.getElementById('whatsapp').value.replace(/\D/g, '');
        const saudacao = getSaudacao();
        const opcao = document.getElementById('select-mensagem').value;
        let msg = "";
        if (opcao === "1") msg = `Ol√° ${nomeCompleto.split(' ')[0]}, ${saudacao.toLowerCase()}!\nVi que n√£o finalizou seu pedido. Cupom: *FRETE-10* para voc√™ agora! ü•Ç`;
        else if (opcao === "2") msg = `${saudacao}, ${nomeCompleto.split(' ')[0]}.\nSeu pedido est√° nos preparos finais! üòç`;
        else if (opcao === "3") msg = `Seu pedido j√° est√° em rota! üöÄ Prepare a ta√ßa!`;
        else if (opcao === "4") msg = `Drink entregue! üòç Gostou? Posta e marca a gente! Sa√∫de! ü•Ç`;
        if (!telefone) return alert("Preencha o WhatsApp.");
        window.open(`https://api.whatsapp.com/send?phone=55${telefone}&text=${encodeURIComponent(msg)}`, '_blank');
    }
</script>
</body>
</html>
