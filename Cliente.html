
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Nuance - Sistema Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f1f5f9; --whatsapp: #25d366; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        
        /* ESTRUTURA PDV DESKTOP */
        .main-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .top-bar { background: #0f172a; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .pdv-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        
        .panel-left { flex: 1.2; background: white; border-radius: 12px; padding: 20px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .panel-right { flex: 0.8; background: #e2e8f0; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; border: 2px inset #cbd5e1; }

        /* RESPONSIVIDADE CELULAR */
        @media (max-width: 900px) {
            .pdv-container { flex-direction: column; overflow: visible; height: auto; padding: 10px; }
            .panel-left, .panel-right { flex: none; width: 100%; overflow: visible; box-sizing: border-box; }
            .main-wrapper { height: auto; }
            .panel-right { margin-top: 20px; background: white; border: none; padding: 0; }
        }

        h2 { margin: 0; font-size: 20px; }
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 15px 0 10px; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .import-box { background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        textarea#input-importacao { width: 100%; height: 100px; font-size: 13px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ddd; padding: 8px; box-sizing: border-box; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #475569; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: inherit; }
        
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: 600; cursor: pointer; font-size: 13px; width: 100%; display: block; margin-bottom: 8px; text-transform: uppercase; transition: opacity 0.2s; }
        .btn-importar { background: #f59e0b; color: white; }
        .btn-maps { background: #16a34a; color: white; }
        .btn-wpp-entrega { background: var(--whatsapp); color: white; }
        .btn-limpar { background: #64748b; color: white; }
        .btn-gerar { background: var(--primary); color: white; margin-top: 15px; font-size: 15px; padding: 16px; }
        .btn-print { background: var(--success); color: white; width: 200px; }
        .btn-pdf { background: #334155; color: white; width: 200px; }
        .btn-nav { background: #334155; color: white; padding: 8px 12px; width: auto; font-size: 11px; margin-left: 4px; }
        .btn-excluir { background: #fee2e2; color: #dc2626; padding: 8px; border-radius: 6px; width: auto; margin-left: 10px; border: 1px solid #fecaca; }

        #area-cupom { 
            width: 80mm; min-height: 120mm; padding: 5mm; background: white; color: #000;
            font-family: 'Courier New', Courier, monospace; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid #ddd; display: none;
        }
        .empresa-nome { text-align: center; font-family: 'Trebuchet MS', sans-serif; font-size: 26px; font-weight: 900; letter-spacing: 2px; margin-bottom: 2px; }
        .cupom-header { text-align: center; border-bottom: 1px dashed #000; margin-bottom: 5px; padding-bottom: 5px; }
        .divisor { border-top: 1px dashed #000; margin: 5px 0; }
        .total-cupom { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .versiculo-box { margin-top: 15px; font-size: 11px; text-align: center; font-style: italic; border-top: 1px dashed #000; padding-top: 10px; }
        .contato-rodape { text-align: center; margin-top: 10px; font-size: 11px; font-weight: bold; }
        .cupom-proxima { text-align: center; margin-top: 10px; font-size: 11px; border: 1px solid #000; padding: 5px; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 95%; max-width: 500px; border-radius: 12px; position: relative; }
        .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }
        .item-nota-container { display: flex; align-items: center; margin-bottom: 8px; }
        .item-nota { background: #f8fafc; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex-grow: 1; text-align: left; }
        .badge-count { background: #8b5cf6; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; }
        .badge-qty { background: #0ea5e9; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        @media print {
            body * { visibility: hidden; }
            #area-cupom, #area-cupom * { visibility: visible; }
            #area-cupom { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="top-bar">
        <h2>PDV NUANCE</h2>
        <div style="display:flex;">
            <button class="btn btn-nav" onclick="abrirGestao()">üìÅ NOTAS</button>
            <button class="btn btn-nav" onclick="abrirRanking()">üë§ CLIENTES</button>
            <button class="btn btn-nav" style="background:#0ea5e9;" onclick="abrirRankingProdutos()">üì¶ PRODUTOS</button>
        </div>
    </div>

    <div class="pdv-container">
        <div class="panel-left">
            <div class="import-box">
                <label>üì¶ IMPORTAR PEDIDO:</label>
                <textarea id="input-importacao" placeholder="Cole a mensagem aqui..."></textarea>
                <div class="grid">
                    <button class="btn btn-importar" onclick="processarTexto()">Processar Mensagem</button>
                    <button class="btn btn-maps" onclick="abrirGoogleMaps()">üìç Mapa Cliente</button>
                </div>
                <div class="grid">
                    <button class="btn btn-wpp-entrega" onclick="enviarWppEntregador()">üì≤ Enviar Motoboy</button>
                    <button class="btn btn-limpar" onclick="limparCampos()">üßπ Limpar Tudo</button>
                </div>
            </div>

            <div class="section-title">Dados da Nota</div>
            <div class="grid">
                <div class="form-group"><label>Nome</label><input type="text" id="nome"></div>
                <div class="form-group"><label>Data/Hora</label><input type="text" id="data-hora"></div>
                <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsapp"></div>
                <div class="form-group"><label>CPF</label><input type="text" id="CPF"></div>
                <div class="form-group"><label>Coleta</label><input type="text" id="coleta"></div>
                <div class="form-group"><label>Cupom</label><input type="text" id="cupom-input"></div>
            </div>

            <div class="form-group">
                <label>Produtos (Ex: 2x Gin, 1x Gelo)</label>
                <textarea id="produtos-texto" style="height: 80px;"></textarea>
            </div>

            <div class="grid">
                <div class="form-group"><label>Total (R$)</label><input type="text" id="valor-total" style="font-weight: bold; color: var(--primary);"></div>
                <div class="form-group"><label>Observa√ß√µes</label><input type="text" id="obs"></div>
            </div>

            <button class="btn btn-gerar" onclick="gerarCupom()">FINALIZAR E GERAR CUPOM</button>
        </div>

        <div class="panel-right">
            <div id="area-cupom">
                <div class="empresa-nome">NUANCE</div>
                <div class="cupom-header"><strong>COMPROVANTE DE PEDIDO</strong></div>
                <div style="font-size: 12px; margin: 10px 0;">
                    DATA: <span id="view-data"></span><br>
                    CLIENTE: <span id="view-nome"></span><br>
                    <div id="row-cpf" style="display:none;">CPF: <span id="view-cpf"></span></div>
                    CONTATO: <span id="view-contato"></span><br>
                    COLETA: <span id="view-coleta"></span>
                </div>
                <div class="divisor"></div>
                <div style="font-size: 12px;"><div id="view-produtos" style="white-space: pre-wrap;"></div></div>
                <div class="divisor"></div>
                <div class="total-cupom"><span>TOTAL:</span><span id="view-total"></span></div>
                <div id="view-obs" style="font-size: 11px; margin-top: 10px; white-space: pre-wrap;"></div>
                <div id="view-proxima-compra" class="cupom-proxima" style="display:none;">Em sua Pr√≥xima Compra Use esse Cupom: <strong id="view-cupom-texto"></strong></div>
                <div id="view-versiculo" class="versiculo-box"></div>
                <div class="contato-rodape">Instagram: Nuance_drinks<br>62995679219</div>
            </div>
            <div id="acoes-cupom" style="margin-top: 20px; display: none; gap: 10px;">
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-pdf" onclick="baixarPDF()">üíæ PDF</button>
            </div>
        </div>
    </div>
</div>

<div id="modalGestao" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalGestao')">√ó</span>
        <h3>Hist√≥rico de Notas</h3>
        <input type="text" id="input-pesquisa" class="search-input" placeholder="Buscar Nome, Data, CPF ou WhatsApp..." onkeyup="filtrarNotas()" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:6px;">
        <div id="lista-notas"></div>
    </div>
</div>

<div id="modalRanking" class="modal"><div class="modal-content"><span class="close" onclick="fecharModal('modalRanking')">√ó</span><h3>Ranking Clientes</h3><div id="lista-ranking"></div></div></div>

<div id="modalRankingProdutos" class="modal"><div class="modal-content"><span class="close" onclick="fecharModal('modalRankingProdutos')">√ó</span><h3>üìä Ranking de Produtos</h3><div id="lista-ranking-produtos"></div></div></div>

<script>
    const versiculos = ["O Senhor √© o meu pastor, nada me faltar√°.", "Tudo posso naquele que me fortalece.", "O Senhor te aben√ßoe e te guarde.", "Confia no Senhor de todo o teu cora√ß√£o.", "O amor nunca falha.", "Mil cair√£o ao teu lado, mas tu n√£o ser√°s atingido."];

    function removerEmojis(texto) { return texto.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, ''); }

    function limparCampos() {
        ['input-importacao','nome','data-hora','whatsapp','CPF','coleta','cupom-input','produtos-texto','valor-total','obs'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('area-cupom').style.display = 'none';
        document.getElementById('acoes-cupom').style.display = 'none';
    }

    function processarTexto() {
        let texto = document.getElementById('input-importacao').value;
        texto = removerEmojis(texto);
        const map = { '0. DATA\/HORA:': 'data-hora', '1. PEDIDO:': 'produtos-texto', '2. NOME:': 'nome', '3. WHATSAPP:': 'whatsapp', '4. CEP:': 'CPF', '9. TIPO DE COLETA:': 'coleta', '10. VALOR PRODUTOS:': 'valor-total' };
        Object.keys(map).forEach(key => {
            const match = texto.match(new RegExp(key + " (.*)"));
            if(match) {
                let val = match[1].trim();
                if(key === '1. PEDIDO:') val = val.replace(/(\d+x)/g, '\n$1').trim();
                document.getElementById(map[key]).value = val;
            }
        });

        const dadosParaSalvar = {
            id: Date.now() + Math.random(),
            nome: document.getElementById('nome').value,
            data: document.getElementById('data-hora').value,
            whatsapp: document.getElementById('whatsapp').value.replace(/\D/g,''),
            whatsappExibicao: document.getElementById('whatsapp').value,
            cpf: document.getElementById('CPF').value,
            coleta: document.getElementById('coleta').value,
            produtos: document.getElementById('produtos-texto').value,
            total: document.getElementById('valor-total').value,
            obs: document.getElementById('obs').value,
            cupomProxima: document.getElementById('cupom-input').value,
            versiculo: versiculos[Math.floor(Math.random() * versiculos.length)]
        };
        let notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        notas.push(dadosParaSalvar);
        localStorage.setItem('notas_nuance', JSON.stringify(notas));
        alert("Nota salva com sucesso!");
    }

    function gerarCupom() {
        const d = { 
            nome: document.getElementById('nome').value, 
            data: document.getElementById('data-hora').value, 
            whatsapp: document.getElementById('whatsapp').value, 
            cpf: document.getElementById('CPF').value, 
            coleta: document.getElementById('coleta').value, 
            produtos: document.getElementById('produtos-texto').value, 
            total: document.getElementById('valor-total').value, 
            obs: document.getElementById('obs').value, 
            cupomProxima: document.getElementById('cupom-input').value, 
            versiculo: versiculos[Math.floor(Math.random() * versiculos.length)] 
        };
        if(!d.nome) return alert("Preencha o nome");
        document.getElementById('view-nome').innerText = d.nome.toUpperCase();
        document.getElementById('view-data').innerText = d.data;
        document.getElementById('view-contato').innerText = d.whatsapp;
        document.getElementById('view-coleta').innerText = d.coleta.toUpperCase();
        document.getElementById('view-produtos').innerText = d.produtos;
        document.getElementById('view-total').innerText = d.total;
        document.getElementById('view-versiculo').innerText = d.versiculo;
        
        const rowCpf = document.getElementById('row-cpf');
        if(d.cpf && d.cpf.length >= 11) { document.getElementById('view-cpf').innerText = d.cpf; rowCpf.style.display = "block"; } else { rowCpf.style.display = "none"; }
        
        const divCp = document.getElementById('view-proxima-compra');
        if(d.cupomProxima) { document.getElementById('view-cupom-texto').innerText = d.cupomProxima.toUpperCase(); divCp.style.display = "block"; } else { divCp.style.display = "none"; }
        
        document.getElementById('view-obs').innerHTML = d.obs ? "<strong>OBS:</strong> " + d.obs : "";
        document.getElementById('area-cupom').style.display = 'block';
        document.getElementById('acoes-cupom').style.display = 'flex';
    }

    function abrirGoogleMaps() {
        const t = document.getElementById('input-importacao').value;
        const loc = t.match(/5\. LOCALIZA√á√ÉO: (.*)/);
        if (loc) window.open("https://www.google.com/maps/search/" + encodeURIComponent(loc[1]), '_blank');
        else alert("Endere√ßo n√£o encontrado");
    }

    function enviarWppEntregador() {
        const msg = `üöÄ *ENTREGA NUANCE*\nüë§ *Cliente:* ${document.getElementById('nome').value}\nüì¶ *Pedido:* ${document.getElementById('produtos-texto').value}\nüí∞ *Total:* ${document.getElementById('valor-total').value}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function renderizarListaNotas(notasParaExibir) {
        const lista = document.getElementById('lista-notas');
        lista.innerHTML = notasParaExibir.length === 0 ? "Nenhum resultado." : "";
        [...notasParaExibir].reverse().forEach(n => {
            const container = document.createElement('div');
            container.className = "item-nota-container";
            container.innerHTML = `
                <div class="item-nota" onclick='carregarNota(${JSON.stringify(n)})'>
                    <strong>${n.nome}</strong><br><small>${n.data}</small>
                </div>
                <button class="btn-excluir" onclick='excluirNota(${n.id})'>üóëÔ∏è</button>
            `;
            lista.appendChild(container);
        });
    }

    function carregarNota(n) {
        document.getElementById('nome').value = n.nome;
        document.getElementById('data-hora').value = n.data;
        document.getElementById('whatsapp').value = n.whatsappExibicao;
        document.getElementById('produtos-texto').value = n.produtos;
        document.getElementById('valor-total').value = n.total;
        gerarCupom(); fecharModal('modalGestao');
    }

    function excluirNota(id) {
        if(confirm("Excluir esta nota permanentemente?")) {
            let notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
            notas = notas.filter(n => n.id !== id);
            localStorage.setItem('notas_nuance', JSON.stringify(notas));
            renderizarListaNotas(notas);
        }
    }

    function filtrarNotas() {
        const termo = document.getElementById('input-pesquisa').value.toLowerCase();
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const filtradas = notas.filter(n => n.nome.toLowerCase().includes(termo) || n.whatsapp.includes(termo));
        renderizarListaNotas(filtradas);
    }

    function abrirRankingProdutos() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const ranking = {};
        notas.forEach(nota => {
            if (nota.produtos) {
                nota.produtos.split('\n').forEach(linha => {
                    const match = linha.match(/(\d+)x\s*(.*)/i);
                    if (match) {
                        const qtd = parseInt(match[1]);
                        const nomeProd = match[2].trim().toUpperCase();
                        ranking[nomeProd] = (ranking[nomeProd] || 0) + qtd;
                    }
                });
            }
        });
        const lista = document.getElementById('lista-ranking-produtos');
        lista.innerHTML = "";
        Object.entries(ranking).sort((a,b) => b[1] - a[1]).forEach(([nome, qtd]) => {
            lista.innerHTML += `<div style="display:flex; justify-content:space-between; background:#f8fafc; padding:10px; margin-bottom:5px; border-radius:8px;"><span>${nome}</span><span class="badge-qty">${qtd}x</span></div>`;
        });
        document.getElementById('modalRankingProdutos').style.display = 'block';
    }

    function abrirGestao() { renderizarListaNotas(JSON.parse(localStorage.getItem('notas_nuance') || '[]')); document.getElementById('modalGestao').style.display="block"; }
    function abrirRanking() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const freq = {};
        notas.forEach(n => { if(!freq[n.whatsapp]) freq[n.whatsapp]={nome:n.nome, total:0}; freq[n.whatsapp].total++; });
        const lista = document.getElementById('lista-ranking');
        lista.innerHTML = "";
        Object.entries(freq).sort((a,b)=>b[1].total-a[1].total).forEach(([w, i]) => {
            lista.innerHTML += `<div style="display:flex; justify-content:space-between; background:#f8fafc; padding:10px; margin-bottom:5px; border-radius:8px;"><span>${i.nome}</span><span class="badge-count">${i.total} pedidos</span></div>`;
        });
        document.getElementById('modalRanking').style.display="block";
    }

    function fecharModal(id) { document.getElementById(id).style.display="none"; }
    function baixarPDF() { html2pdf().set({ margin: 0, filename: 'Nuance.pdf', jsPDF: { unit: 'mm', format: [80, 200] } }).from(document.getElementById('area-cupom')).save(); }
</script>
</body>
</html>
