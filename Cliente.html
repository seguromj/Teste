
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Nuance - Sistema Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f1f5f9; --whatsapp: #25d366; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        
        .main-wrapper { display: flex; flex-direction: column; height: 100vh; }
        
        .top-bar { 
            background: #0f172a; 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        
        .pdv-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
        .panel-left { flex: 1.2; background: white; border-radius: 12px; padding: 20px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .panel-right { flex: 0.8; background: #e2e8f0; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; border: 2px inset #cbd5e1; }

        @media (max-width: 900px) {
            .pdv-container { flex-direction: column; overflow: visible; height: auto; padding: 10px; }
            .panel-left, .panel-right { flex: none; width: 100%; overflow: visible; box-sizing: border-box; }
            .main-wrapper { height: auto; }
            .panel-right { margin-top: 20px; background: white; border: none; padding: 0; }
        }

        h2 { margin: 0; font-size: 20px; }
        .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 15px 0 10px; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #475569; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: inherit; }
        
        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: 600; cursor: pointer; font-size: 13px; width: 100%; display: block; margin-bottom: 8px; text-transform: uppercase; transition: opacity 0.2s; }
        .btn-importar { background: #f59e0b; color: white; }
        .btn-maps { background: #16a34a; color: white; }
        .btn-wpp-entrega { background: var(--whatsapp); color: white; }
        .btn-limpar { background: #64748b; color: white; }
        .btn-gerar { background: var(--primary); color: white; margin-top: 15px; font-size: 15px; padding: 16px; }
        .btn-print { background: var(--success); color: white; width: 100%; }
        .btn-pdf { background: #334155; color: white; width: 100%; }
        .btn-nav { background: #334155; color: white; padding: 8px 12px; width: auto; font-size: 11px; margin-left: 4px; }
        .btn-crm { background: var(--whatsapp); color: white; margin-top: 5px; }
        .btn-delete { background: var(--danger); color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-reabrir { background: var(--primary); color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-lancar { background: #10b981; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }
        .btn-etiqueta { background: #f59e0b; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 4px; }

        #lista-notas { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .nota-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .nota-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .nota-cliente-info b { font-size: 15px; color: #16a34a; display: block; text-transform: uppercase; }
        .nota-cliente-info span { font-size: 11px; color: #64748b; }
        
        .nota-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .nota-status-row { display: flex; align-items: center; gap: 8px; padding-top: 10px; border-top: 1px solid #f1f5f9; margin-top: 5px; }
        .btn-icon-wpp { background: #25d366; color: white; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }

        .status-badge { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; color: white; text-transform: uppercase; border: none; outline: none; }
        .st-pendente { background: #64748b; }
        .st-preparando { background: #3b82f6; }
        .st-rua { background: #f59e0b; }
        .st-entregue { background: #10b981; }

        .product-folder { background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .folder-header { background: #f8fafc; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #eee; }
        .folder-content { padding: 12px; background: #fff; border-top: 1px solid #eee; }
        .sub-folder { border-top: 1px solid #f1f5f9; padding: 5px 10px; font-size: 12px; }

        #area-cupom, #area-etiqueta { 
            width: 80mm; padding: 5mm; background: white; color: #000;
            font-family: 'Courier New', Courier, monospace; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid #ddd; margin-bottom: 20px;
        }
        #area-etiqueta { min-height: 50mm; display: none; border: 2px solid #000; }
        .empresa-nome { text-align: center; font-family: 'Trebuchet MS', sans-serif; font-size: 26px; font-weight: 900; letter-spacing: 2px; margin-bottom: 2px; }
        .divisor { border-top: 1px dashed #000; margin: 5px 0; }

        .tipo-badge { text-align: center; font-weight: bold; padding: 6px; margin: 5px 0; font-size: 13px; text-transform: uppercase; }
        .badge-mesa { background: #000; color: #fff; }
        .badge-retirada { border: 2px dashed #000; color: #000; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 95%; max-width: 600px; border-radius: 12px; position: relative; }
        .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }

        @media print {
            body * { visibility: hidden; }
            #area-cupom, #area-cupom *, #area-etiqueta, #area-etiqueta * { visibility: visible; }
            #area-cupom, #area-etiqueta { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
        }
    </style>
</head>
<body onload="atualizarCupom()">

<div class="main-wrapper">
    <div class="top-bar">
        <h2>PDV NUANCE</h2>
        <div style="display:flex;">
            <button class="btn btn-nav" onclick="abrirGestao()">üìÅ NOTAS</button>
            <button class="btn btn-nav" onclick="abrirRankingClientes()">üë§ CLIENTES</button>
            <button class="btn btn-nav" style="background:#0ea5e9;" onclick="abrirRankingProdutos()">üì¶ PRODUTOS</button>
        </div>
    </div>

    <div class="pdv-container">
        <div class="panel-left">
            <div class="import-box" style="background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label>üì¶ IMPORTAR PEDIDO:</label>
                <textarea id="input-importacao" style="width: 100%; height: 100px; font-size: 13px; margin-bottom: 10px;" placeholder="Cole a mensagem aqui..."></textarea>
                <div class="grid">
                    <button class="btn btn-importar" onclick="processarTexto()">Processar Mensagem</button>
                    <button class="btn btn-maps" onclick="abrirGoogleMaps()">üìç Mapa Cliente</button>
                </div>
                <div class="grid">
                    <button class="btn btn-wpp-entrega" onclick="enviarWppEntregador()">üì≤ Enviar Motoboy</button>
                    <button class="btn btn-limpar" onclick="limparCampos()">üßπ Limpar Tudo</button>
                </div>
            </div>

            <div class="section-title">Dados da Nota</div>
            <div class="grid">
                <div class="form-group"><label>Nome</label><input type="text" id="nome" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Data/Hora</label><input type="text" id="data-hora" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsapp" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>CPF / Ref</label><input type="text" id="CPF" oninput="atualizarCupom()"></div>
            </div>

            <div class="section-title">Endere√ßo de Entrega</div>
            <div class="grid">
                <div class="form-group"><label>Rua/Avenida</label><input type="text" id="rua" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>N¬∫/QD/LOTE</label><input type="text" id="numero" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Bairro</label><input type="text" id="bairro" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>CEP</label><input type="text" id="cep" oninput="atualizarCupom()"></div>
            </div>
            <div class="form-group"><label>Complemento</label><input type="text" id="complemento" oninput="atualizarCupom()"></div>

            <div class="section-title">Pagamento e Produtos</div>
            <div class="grid">
                <div class="form-group"><label>Forma de Pagamento</label><input type="text" id="pagamento" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Coleta</label><input type="text" id="coleta" oninput="atualizarCupom()"></div>
            </div>
            <div class="form-group"><label>Est√° Pago?</label><input type="text" id="esta-pago" placeholder="Ex: SIM / N√ÉO / PIX" oninput="atualizarCupom()"></div>
            <div class="form-group"><label>Produtos (Ex: 2x Gin)</label><textarea id="produtos-texto" style="height: 80px;" oninput="atualizarCupom()"></textarea></div>
            <div class="grid">
                <div class="form-group"><label>Total (R$)</label><input type="text" id="valor-total" oninput="atualizarCupom()"></div>
                <div class="form-group"><label>Cupom de Desconto</label><input type="text" id="cupom-input" oninput="atualizarCupom()"></div>
            </div>
            <div class="form-group"><label>Observa√ß√µes</label><input type="text" id="obs" oninput="atualizarCupom()"></div>

            <div class="section-title">üí¨ Mensagens R√°pidas</div>
            <div class="form-group">
                <select id="select-mensagem">
                    <option value="1">‚ö†Ô∏è Carrinho Abandonado</option>
                    <option value="2">üë®‚Äçüç≥ Pedido em Preparo</option>
                    <option value="3">üöÄ Saiu para Entrega</option>
                    <option value="4">‚úÖ Entregue / Feedback</option>
                </select>
                <button class="btn btn-crm" onclick="enviarMensagemRapida()">Enviar para Cliente</button>
            </div>

            <button class="btn btn-gerar" onclick="finalizarEGerar()">FINALIZAR E SALVAR</button>
        </div>

        <div class="panel-right">
            <div id="area-cupom">
                <div class="empresa-nome">NUANCE</div>
                <div style="text-align: center; font-size: 12px; border-bottom: 1px dashed #000; margin-bottom: 5px;"><strong>COMPROVANTE DE PEDIDO</strong></div>
                <div id="badge-container"></div>
                <div style="font-size: 12px; margin: 10px 0; line-height: 1.4;">
                    DATA: <span id="view-data"></span><br>
                    CLIENTE: <span id="view-nome"></span><br>
                    <div id="view-endereco-bloco">ENDERE√áO: <span id="view-endereco"></span><br></div>
                    COLETA: <span id="view-coleta"></span><br>
                    <div id="view-zap-bloco">ZAP: <span id="view-zap"></span><br></div>
                    <div id="view-cpf-bloco">CPF/REF: <span id="view-cpf"></span><br></div>
                    <div id="view-pag-bloco">PAGAMENTO: <span id="view-pag"></span></div>
                </div>
                <div class="divisor"></div>
                <div id="view-produtos" style="font-size: 12px; white-space: pre-wrap;"></div>
                <div class="divisor"></div>
                <div id="view-pago-bloco" style="text-align:center; font-weight:bold; font-size:13px; margin: 5px 0;">EST√Å PAGO: <span id="view-pago-status"></span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;"><span>TOTAL:</span><span id="view-total">R$ 0.00</span></div>
                <div id="view-cupom-aplicado" style="font-size: 11px; margin-top: 8px; text-align: center; border: 1px dashed #000; padding: 4px; display:none;"></div>
                <div id="view-obs" style="font-size: 11px; margin-top: 10px; white-space: pre-wrap;"></div>
                <div id="view-versiculo" class="versiculo-box" style="margin-top: 15px; font-size: 11px; text-align: center; font-style: italic; border-top: 1px dashed #000; padding-top: 10px;"></div>
            </div>

            <div id="area-etiqueta">
                <div style="text-align: center; border: 2px solid #000; padding: 5px;">
                    <div style="font-weight: bold; font-size: 18px;">NUANCE DRINKS</div>
                    <div class="divisor"></div>
                    <div style="text-align: left; font-size: 14px;">
                        <strong>CLIENTE:</strong> <span id="etiq-nome"></span><br>
                        <strong>END:</strong> <span id="etiq-end"></span><br>
                        <strong>OBS:</strong> <span id="etiq-obs"></span>
                    </div>
                    <div class="divisor"></div>
                    <div id="etiq-prod" style="font-size: 14px; text-align: left; font-weight: bold;"></div>
                </div>
            </div>

            <div style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Cupom</button>
                <button class="btn btn-etiqueta" style="width:100%;" onclick="imprimirEtiqueta()">üè∑Ô∏è Etiqueta</button>
                <button class="btn btn-pdf" onclick="baixarPDF()">üíæ PDF</button>
                <button class="btn btn-limpar" style="width:100%;" onclick="limparCampos()">üßπ Limpar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalGestao" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalGestao')">√ó</span>
        <h3>Hist√≥rico e Status</h3>
        <input type="text" id="busca-nota" placeholder="Busca: Nome * Zap" onkeyup="filtrarNotas()" style="margin-bottom:15px;">
        <div id="lista-notas"></div>
    </div>
</div>

<div id="modalLancar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalLancar')">√ó</span>
        <h3>üöÄ Realizar Lan√ßamento</h3>
        <p id="lancar-info-cliente" style="font-weight: bold; color: var(--primary);"></p>
        <div id="lista-produtos-lancar"></div>
        <button class="btn btn-gerar" onclick="confirmarLancamento()">CONFIRMAR VALORES</button>
    </div>
</div>

<div id="modalRankingProdutos" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalRankingProdutos')">√ó</span>
        <h3>üì¶ Controle de Produtos</h3>
        <div style="background:#0f172a; color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
            Total Lan√ßado: <span id="fin-total-lucro" style="color:#4ade80; font-weight:bold;">R$ 0,00</span>
        </div>
        <div id="lista-ranking-produtos"></div>
    </div>
</div>

<div id="modalRankingClientes" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal('modalRankingClientes')">√ó</span>
        <h3>Ranking Clientes</h3>
        <div id="lista-ranking-clientes"></div>
    </div>
</div>

<script>
    const versiculos = ["O Senhor √© o meu pastor, nada me faltar√°.", "Tudo posso naquele que me fortalece.", "O Senhor te aben√ßoe e te guarde.", "O amor nunca falha.", "Confia no Senhor de todo o teu cora√ß√£o."];

    function atualizarCupom() {
        const nome = document.getElementById('nome').value.toUpperCase();
        const rua = document.getElementById('rua').value;
        const num = document.getElementById('numero').value;
        const bairro = document.getElementById('bairro').value;
        const zap = document.getElementById('whatsapp').value;
        const cpf = document.getElementById('CPF').value;
        const pag = document.getElementById('pagamento').value;
        const coleta = (document.getElementById('coleta').value || "").toUpperCase();
        const prod = document.getElementById('produtos-texto').value;
        const obs = document.getElementById('obs').value;
        const cupomV = document.getElementById('cupom-input').value;
        const estaPago = document.getElementById('esta-pago').value.toUpperCase();

        const endFormatado = `${rua}${num ? ', ' + num : ''}${bairro ? ' - ' + bairro : ''}`;

        // L√ìGICA DE DISFARCE
        const badgeBox = document.getElementById('badge-container');
        const endBloco = document.getElementById('view-endereco-bloco');
        badgeBox.innerHTML = '';
        endBloco.style.display = 'block';

        if(coleta.includes("MESA")) {
            badgeBox.innerHTML = `<div class="tipo-badge badge-mesa">ATENDIMENTO EM MESA</div>`;
            endBloco.style.display = 'none';
        } else if(coleta.includes("RETIRADA")) {
            badgeBox.innerHTML = `<div class="tipo-badge badge-retirada">RETIRADA NO LOCAL</div>`;
            endBloco.style.display = 'none';
        }

        document.getElementById('view-nome').innerText = nome || "...";
        document.getElementById('view-data').innerText = document.getElementById('data-hora').value || "...";
        document.getElementById('view-endereco').innerText = endFormatado || "...";
        document.getElementById('view-coleta').innerText = coleta || "...";
        document.getElementById('view-zap').innerText = zap || "";
        document.getElementById('view-zap-bloco').style.display = zap ? 'block' : 'none';
        document.getElementById('view-cpf').innerText = cpf || "";
        document.getElementById('view-cpf-bloco').style.display = cpf ? 'block' : 'none';
        document.getElementById('view-pag').innerText = pag.toUpperCase() || "";
        document.getElementById('view-pag-bloco').style.display = pag ? 'block' : 'none';
        document.getElementById('view-produtos').innerText = prod || "Nenhum produto";
        document.getElementById('view-total').innerText = "R$ " + (document.getElementById('valor-total').value || "0.00");
        document.getElementById('view-obs').innerText = obs ? "OBS: " + obs : "";
        
        // MOSTRAR STATUS DE PAGAMENTO NO CUPOM
        document.getElementById('view-pago-status').innerText = estaPago || "---";

        const vC = document.getElementById('view-cupom-aplicado');
        if(cupomV) { vC.style.display = "block"; vC.innerText = "CUPOM: " + cupomV.toUpperCase(); }
        else vC.style.display = "none";

        document.getElementById('etiq-nome').innerText = nome;
        document.getElementById('etiq-end').innerText = (coleta.includes("MESA") || coleta.includes("RETIRADA")) ? coleta : endFormatado;
        document.getElementById('etiq-obs').innerText = obs;
        document.getElementById('etiq-prod').innerText = prod;

        if(!document.getElementById('view-versiculo').innerText) document.getElementById('view-versiculo').innerText = versiculos[Math.floor(Math.random() * versiculos.length)];
    }

    function processarTexto() {
        let texto = document.getElementById('input-importacao').value;
        if(!texto) return;
        const map = { 
            '0. DATA/HORA:': 'data-hora', '1. PEDIDO:': 'produtos-texto', '2. NOME:': 'nome', 
            '3. WHATSAPP:': 'whatsapp', '4. CEP:': 'cep', '5. N¬∫/QD/LOTE:': 'numero',
            '6. BAIRRO:': 'bairro', '7. RUA/AVENIDA:': 'rua', '8. COMPLEMENTO:': 'complemento',
            '9. TIPO DE COLETA:': 'coleta', '10. VALOR PRODUTOS:': 'valor-total'
        };
        Object.keys(map).forEach(key => {
            const regex = new RegExp(key.replace(/\//g, '\\/') + "\\s*(.*)");
            const match = texto.match(regex);
            if(match) {
                let val = match[1].trim();
                if(key === '1. PEDIDO:') val = val.replace(/(\d+x)/g, '\n$1').trim();
                document.getElementById(map[key]).value = val;
            }
        });
        atualizarCupom();
    }

    function finalizarEGerar() {
        const dados = {
            id: Date.now(),
            nome: document.getElementById('nome').value,
            data: document.getElementById('data-hora').value,
            whatsapp: document.getElementById('whatsapp').value,
            cpf: document.getElementById('CPF').value,
            rua: document.getElementById('rua').value,
            numero: document.getElementById('numero').value,
            bairro: document.getElementById('bairro').value,
            cep: document.getElementById('cep').value,
            complemento: document.getElementById('complemento').value,
            coleta: document.getElementById('coleta').value,
            produtos: document.getElementById('produtos-texto').value,
            total: document.getElementById('valor-total').value,
            pagamento: document.getElementById('pagamento').value,
            obs: document.getElementById('obs').value,
            status: 'pendente'
        };
        let notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        notas.push(dados);
        localStorage.setItem('notas_nuance', JSON.stringify(notas));
        alert("Salvo com sucesso!");
    }

    function filtrarNotas() {
        const busca = document.getElementById('busca-nota').value.toLowerCase();
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const lista = document.getElementById('lista-notas');
        lista.innerHTML = notas.slice().reverse().filter(n => (n.nome||"").toLowerCase().includes(busca)).map(n => `
            <div class="nota-card">
                <div class="nota-header">
                    <div class="nota-cliente-info">
                        <b>${n.nome}</b>
                        <span style="color:#2563eb; font-weight:bold; font-size:10px;">üìå ${ (n.coleta || "DELIVERY").toUpperCase() }</span>
                        <span>üí∞ R$ ${n.total}</span>
                    </div>
                    <div class="nota-actions">
                        <button class="btn btn-lancar" onclick="abrirModalLancar(${n.id})">üöÄ LAN√áAR</button>
                        <button class="btn btn-reabrir" onclick="reabrirNota(${n.id})">üëÅÔ∏è</button>
                        <button class="btn btn-delete" onclick="excluirNota(${n.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="nota-status-row">
                    <select onchange="mudarStatus(${n.id}, this.value)" class="status-badge st-${n.status}">
                        <option value="pendente" ${n.status==='pendente'?'selected':''}>Pendente</option>
                        <option value="preparando" ${n.status==='preparando'?'selected':''}>Preparo</option>
                        <option value="rua" ${n.status==='rua'?'selected':''}>Na Rua</option>
                        <option value="entregue" ${n.status==='entregue'?'selected':''}>Entregue</option>
                    </select>
                    <button onclick="enviarMensagemHistorico(${n.id})" class="btn-icon-wpp">üì≤ AVISAR</button>
                </div>
            </div>
        `).join('');
    }

    function mudarStatus(id, s) {
        let n = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const item = n.find(x => x.id === id);
        if(item) { item.status = s; localStorage.setItem('notas_nuance', JSON.stringify(n)); filtrarNotas(); }
    }

    function abrirModalLancar(id) {
        const nota = JSON.parse(localStorage.getItem('notas_nuance') || '[]').find(x => x.id === id);
        if(!nota) return;
        document.getElementById('lancar-info-cliente').innerText = `Pedido: ${nota.nome}`;
        const lista = document.getElementById('lista-produtos-lancar');
        const valoresSalvos = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        let html = ""; let itemIndex = 0;
        nota.produtos.split('\n').forEach(linha => {
            const m = linha.match(/(\d+)x\s*(.*)/i);
            if(m) {
                const qtd = parseInt(m[1]); const nomeProd = m[2].trim().toUpperCase();
                for(let i=0; i<qtd; i++) {
                    const chave = `${nomeProd}_${nota.id}_${itemIndex}`;
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${nomeProd}</span>
                        <input type="number" class="input-valor-lancar" data-chave="${chave}" value="${valoresSalvos[chave]||0}" style="width:80px;">
                    </div>`;
                    itemIndex++;
                }
            }
        });
        lista.innerHTML = html;
        document.getElementById('modalLancar').style.display = 'block';
    }

    function confirmarLancamento() {
        let valores = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        document.querySelectorAll('.input-valor-lancar').forEach(input => {
            valores[input.getAttribute('data-chave')] = parseFloat(input.value) || 0;
        });
        localStorage.setItem('nuance_valores_individuais', JSON.stringify(valores));
        fecharModal('modalLancar'); alert("Lan√ßado!");
    }

    function abrirRankingProdutos() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const valoresSalvos = JSON.parse(localStorage.getItem('nuance_valores_individuais') || '{}');
        const pastas = {}; let totalGeral = 0;
        notas.forEach(nota => {
            let itemIndex = 0;
            if(nota.produtos) nota.produtos.split('\n').forEach(linha => {
                const m = linha.match(/(\d+)x\s*(.*)/i);
                if(m) {
                    const nomeProd = m[2].trim().toUpperCase();
                    if(!pastas[nomeProd]) pastas[nomeProd] = [];
                    for(let i=0; i<parseInt(m[1]); i++) {
                        const chave = `${nomeProd}_${nota.id}_${itemIndex}`;
                        const v = valoresSalvos[chave] || 0;
                        pastas[nomeProd].push({ cliente: nota.nome, valor: v });
                        totalGeral += parseFloat(v); itemIndex++;
                    }
                }
            });
        });
        document.getElementById('fin-total-lucro').innerText = "R$ " + totalGeral.toFixed(2);
        document.getElementById('lista-ranking-produtos').innerHTML = Object.entries(pastas).map(([nome, itens]) => `
            <div class="product-folder">
                <div class="folder-header" onclick="togglePasta(this)"><span>üìÅ ${nome}</span> <span>${itens.length} un</span></div>
                <div class="folder-content" style="display:none;">
                    ${itens.map(it => `<div class="sub-folder">${it.cliente}: R$ ${parseFloat(it.valor).toFixed(2)}</div>`).join('')}
                </div>
            </div>
        `).join('');
        document.getElementById('modalRankingProdutos').style.display = 'block';
    }

    function abrirRankingClientes() {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const clientes = {};
        notas.forEach(n => { if(n.nome) clientes[n.nome] = (clientes[n.nome] || 0) + 1; });
        document.getElementById('lista-ranking-clientes').innerHTML = Object.entries(clientes).sort((a,b)=>b[1]-a[1]).map(([nome, q]) => `
            <div style="padding:10px; border-bottom:1px solid #eee;"><strong>${nome}</strong>: ${q} pedidos</div>
        `).join('');
        document.getElementById('modalRankingClientes').style.display = 'block';
    }

    function enviarMensagemRapida() {
        const tel = document.getElementById('whatsapp').value.replace(/\D/g, '');
        const tipo = document.getElementById('select-mensagem').value;
        const nomeCompleto = document.getElementById('nome').value;
        const prods = document.getElementById('produtos-texto').value;
        dispararWhatsApp(tel, tipo, nomeCompleto, prods);
    }

    function enviarMensagemHistorico(id) {
        const notas = JSON.parse(localStorage.getItem('notas_nuance') || '[]');
        const n = notas.find(x => x.id === id);
        if(n && n.whatsapp) {
            let tipoMsg = "1";
            if(n.status === "preparando") tipoMsg = "2";
            if(n.status === "rua") tipoMsg = "3";
            if(n.status === "entregue") tipoMsg = "4";
            dispararWhatsApp(n.whatsapp, tipoMsg, n.nome, n.produtos);
        } else {
            alert("WhatsApp n√£o cadastrado para esta nota.");
        }
    }

    function dispararWhatsApp(tel, tipo, nomeFull, prods) {
        let msg = "";
        const telLimpo = tel.replace(/\D/g, '');
        const pNome = (nomeFull || "Cliente").split(' ')[0];
        
        // Intelig√™ncia de reconhecimento de per√≠odo
        const hora = new Date().getHours();
        let saudacao = "Ol√°";
        if (hora >= 5 && hora < 12) saudacao = "Bom dia";
        else if (hora >= 12 && hora < 18) saudacao = "Boa tarde";
        else saudacao = "Boa noite";
        
        if(tipo=="1") {
            msg = `Ol√°, ${pNome}, ${saudacao}! Percebemos que voc√™ deixou seu carrinho cheio üëá:\n\n${prods || "N√£o especificado"}\n\nQue tal finalizar essa compra com esse cupom: FRETEGRATIS\n\n Nosso site Oficial üëá\n https://seguromj.github.io/Nuance-/`;
        } else if(tipo=="2") {
            msg = `${saudacao}, ${pNome}! ü§ó Seu pedido j√° entrou em preparo!\n Estamos dando os √∫ltimos toque final para sua experi√™ncia ser inesquec√≠vel üòç\n\n Assim que o motoboy sa√≠ para a entrega, n√≥s o avisaremos.`;
        } else if(tipo=="3") {
            msg = `${saudacao}, ${pNome}! ü§ó Seu pedido acabou de sair para entrega! üöÄ Logo o motoboy chegar√° a√≠!`;
        } else if(tipo=="4") {
            msg = `${saudacao}, ${pNome}! Acabamos de ser notificado que seu *Pedido foi Entregue*! O que achou da experi√™ncia?\n Sua avalia√ß√£o nos ajuda muito!\n\n Sa√∫de!!! üòâü•Ç`;
        }
        
        if(telLimpo) {
            window.open(`https://api.whatsapp.com/send?phone=55${telLimpo}&text=${encodeURIComponent(msg)}`, '_blank');
        } else {
            alert("N√∫mero de WhatsApp inv√°lido.");
        }
    }

    function reabrirNota(id) {
        const n = JSON.parse(localStorage.getItem('notas_nuance') || '[]').find(x => x.id === id);
        if(n) {
            document.getElementById('nome').value = n.nome||""; document.getElementById('data-hora').value = n.data||"";
            document.getElementById('whatsapp').value = n.whatsapp||""; document.getElementById('CPF').value = n.cpf||"";
            document.getElementById('rua').value = n.rua||""; document.getElementById('numero').value = n.numero||"";
            document.getElementById('bairro').value = n.bairro||""; document.getElementById('cep').value = n.cep||"";
            document.getElementById('coleta').value = n.coleta||""; document.getElementById('produtos-texto').value = n.produtos||"";
            document.getElementById('valor-total').value = n.total||""; document.getElementById('pagamento').value = n.pagamento||"";
            document.getElementById('obs').value = n.obs||"";
            atualizarCupom(); fecharModal('modalGestao');
        }
    }

    function togglePasta(e) { const c = e.nextElementSibling; c.style.display = c.style.display==='none'?'block':'none'; }
    function fecharModal(id) { document.getElementById(id).style.display='none'; }
    function abrirGestao() { document.getElementById('modalGestao').style.display='block'; filtrarNotas(); }
    function limparCampos() { document.querySelectorAll('input, textarea').forEach(i => i.value = ""); atualizarCupom(); }
    function baixarPDF() { html2pdf().from(document.getElementById('area-cupom')).save(); }
    function imprimirEtiqueta() { document.getElementById('area-cupom').style.display='none'; document.getElementById('area-etiqueta').style.display='block'; window.print(); setTimeout(()=> {document.getElementById('area-cupom').style.display='block'; document.getElementById('area-etiqueta').style.display='none';}, 1000); }
    function excluirNota(id) { if(confirm("Excluir?")) { let n = JSON.parse(localStorage.getItem('notas_nuance') || '[]').filter(x=>x.id!==id); localStorage.setItem('notas_nuance', JSON.stringify(n)); filtrarNotas(); } }
    function abrirGoogleMaps() { const end = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}`; window.open("https://www.google.com/maps/search/" + encodeURIComponent(end)); }
    function enviarWppEntregador() { const msg = `üöÄ ENTREGA\nüë§ ${document.getElementById('nome').value}\nüìç ${document.getElementById('rua').value}`; window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`); }
</script>
</body>
</html>
