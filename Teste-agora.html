
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Stock - Scanner Automático</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00e5;
            --bg-dark: #0a0a0c;
            --card-bg: #16161a;
            --text: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text); padding: 15px; }

        header h1 { 
            text-align: center; color: var(--neon-blue); 
            text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 20px; font-size: 1.2rem;
        }

        /* Área do Scanner */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border: 2px solid var(--neon-blue);
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }

        video { width: 100%; display: block; }

        .scan-region {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150px; height: 80px;
            border: 2px solid var(--neon-pink);
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #status {
            text-align: center;
            color: var(--neon-pink);
            font-weight: bold;
            margin-bottom: 10px;
            height: 20px;
        }

        .btn-main {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(45deg, #9d00ff, #ff00e5);
            color: white; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }

        #product-info {
            background: var(--card-bg);
            padding: 15px; border-radius: 8px; border: 1px solid var(--neon-blue);
            margin-top: 20px; display: none;
        }

        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>⚡ Scanner Automático ID</h1></header>

    <div id="status">Aguardando...</div>

    <div id="scanner-container">
        <video id="video" autoplay playsinline></video>
        <div class="scan-region"></div>
    </div>

    <button id="btn-start" class="btn-main" onclick="iniciarScanner()">Ligar Câmera</button>

    <div id="product-info">
        <h3 id="p-nome" style="color: var(--neon-blue);"></h3>
        <p id="p-detalhes" style="font-size: 0.9rem; margin: 5px 0;"></p>
        <div id="baixa-msg" style="color: #00ff00; font-weight: bold; margin-top: 10px;"></div>
    </div>

    <canvas id="canvas-process"></canvas>
</div>

<script>
    let produtos = JSON.parse(localStorage.getItem('neon_produtos')) || [];
    let isScanning = false;
    let video = document.getElementById('video');

    async function iniciarScanner() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 480 } 
            });
            video.srcObject = stream;
            document.getElementById('scanner-container').style.display = 'block';
            document.getElementById('btn-start').style.display = 'none';
            isScanning = true;
            loopLeitura();
        } catch (err) {
            alert("Erro: Para usar a câmera, você precisa abrir este arquivo via HTTPS ou Servidor Local.");
        }
    }

    async function loopLeitura() {
        if (!isScanning) return;

        const canvas = document.getElementById('canvas-process');
        const ctx = canvas.getContext('2d');
        
        // Foca apenas na região central (caixa rosa) para aumentar a precisão
        canvas.width = 150;
        canvas.height = 80;
        
        // Desenha a parte central do vídeo no canvas
        ctx.drawImage(video, (video.videoWidth/2 - 75), (video.videoHeight/2 - 40), 150, 80, 0, 0, 150, 80);

        document.getElementById('status').innerText = "Lendo...";

        // Processa a imagem com Tesseract
        Tesseract.recognize(canvas, 'eng', {
            tessedit_char_whitelist: '0123456789'
        }).then(({ data: { text } }) => {
            const idEncontrado = text.trim().replace(/\D/g, "");
            
            if (idEncontrado.length >= 1) {
                processarBaixaAutomatica(idEncontrado);
            }

            if (isScanning) setTimeout(loopLeitura, 500); // Tenta ler a cada meio segundo
        });
    }

    function processarBaixaAutomatica(id) {
        const index = produtos.findIndex(p => p.id == id);
        
        if (index !== -1) {
            if (produtos[index].qtd > 0) {
                isScanning = false; // Para o scanner para não dar baixa múltipla
                produtos[index].qtd -= 1;
                
                // Salva e Atualiza
                localStorage.setItem('neon_produtos', JSON.stringify(produtos));
                
                // Mostra na tela
                exibirSucesso(produtos[index]);
                
                // Reinicia o scanner após 3 segundos
                setTimeout(() => {
                    document.getElementById('product-info').style.display = 'none';
                    isScanning = true;
                    loopLeitura();
                }, 3000);
            }
        }
    }

    function exibirSucesso(produto) {
        const info = document.getElementById('product-info');
        info.style.display = 'block';
        document.getElementById('p-nome').innerText = "PRODUTO: " + produto.nome;
        document.getElementById('p-detalhes').innerText = "ID: " + produto.id + " | NOVO ESTOQUE: " + produto.qtd;
        document.getElementById('baixa-msg').innerText = "✅ BAIXA REALIZADA AUTOMATICAMENTE!";
        document.getElementById('status').innerText = "Aguardando próximo...";
    }
</script>

</body>
</html>

